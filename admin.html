<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin RAUN-Rachid2025</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="admin-capsule.js"></script>
  <style>
    html, body {
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      overflow: hidden; /* D√©sactive le scroll g√©n√©ral */
    }
    body {
      background: black;
      color: #33ff33;
      font-family: monospace;
      min-height: 100vh;
    }
    .slider-btn {
      background: #222;
      color: #00ff99;
      border: none;
      font-size: 2.2rem;
      border-radius: 9px;
      cursor: pointer;
      margin: 0 20px;
      padding: 6px 18px 4px 18px;
      transition: background 0.15s;
      z-index: 5;
    }
    .slider-btn:active { background: #080; }
    .capsule-admin-slider { display: flex; align-items: center; justify-content: center; margin-top: 18px;}
    #adminCapsule { flex:1; min-height: 280px; }
    .capsule {
      background: rgba(0,30,0,0.92);
      border: 2.5px solid #00ff66;
      border-radius: 22px;
      margin: 18px auto;
      padding: 18px 24px 18px 24px;
      color: #ccffcc;
      box-shadow: 0 0 32px 4px #0f0a;
      min-width: 340px;
      max-width: 920px;
      min-height: 180px;
      max-height: 38vh;
      font-size: 1.13rem;
      z-index: 4;
      display: flex;
      flex-direction: column;
    }
    .capsule-content {
      flex: 1 1 0;
      overflow-y: auto;
      max-height: 18vh;
      min-height: 7vh;
      padding-right: 6px;
      margin-bottom: 7px;
    }
    .profile-photo {
      width: 100px; height: 100px;
      display: block;
      margin: 30px auto 8px auto;
      border-radius: 50%;
      box-shadow: 0 0 30px #00ff99aa, 0 0 0 7px #111;
      border: 4px solid #001f15;
      object-fit: cover;
      z-index: 2;
    }
    .login-box {
      background: rgba(0,32,0,0.78);
      box-shadow: 0 0 24px 2px #00ff77;
      border-radius: 18px;
      padding: 36px 38px 24px 38px;
      margin: 38px auto 24px auto;
      max-width: 410px;
      min-width: 320px;
      text-align: center;
      border: 1.5px solid #00ff77;
      z-index: 2;
    }
    .login-box input[type="email"],
    .login-box input[type="password"] {
      width: 90%;
      max-width: 320px;
      margin: 8px auto 18px auto;
      font-size: 1.12rem;
      display: block;
      background: #111b18;
      color: #aaffbb;
      border: 1.5px solid #00ff99;
      border-radius: 8px;
      padding: 10px 12px;
      outline: none;
      transition: border 0.2s;
    }
    .login-box input:focus { border: 1.5px solid #00ffd9; }
    .login-box button {
      margin: 20px auto 0 auto;
      width: 160px;
      font-size: 1.13rem;
      background: #000;
      color: #00ff77;
      border: 2px solid #00ff77;
      border-radius: 9px;
      padding: 10px 0;
      cursor: pointer;
      transition: background 0.17s, color 0.17s;
      display: block;
    }
    .login-box button:hover { background: #00ff99; color: #000; }
    .login-box h2 { color: #39ff5e; font-size: 1.35rem; margin-bottom: 18px; margin-top: 0; }
    .danger { color: #ff6666; font-size: 1.1em; margin-top: 8px; }
    @media (max-width:700px) {
      .slider-btn { font-size: 1.6rem; margin: 0 4vw; padding: 4px 4vw; }
      .capsule { min-width: 95vw; max-width: 99vw; font-size: 1.03rem; }
      .login-box { max-width: 97vw; padding: 12vw 2vw 7vw 2vw; }
    }
  </style>
</head>
<body>
  <img src="photo.jpg" alt="Rachid" class="profile-photo">
  <a href="index.html" style="color:#00ffff;">‚Üê Retour √† la page publique</a>
  <div class="login-box" id="loginBox">
    <h2>Connexion Admin <span style="font-size:1.5em;">üîê</span></h2>
    <input type="email" id="adminEmail" placeholder="Email" required><br><br>
    <input type="password" id="adminPassword" placeholder="Mot de passe" required><br><br>
    <button onclick="loginAdmin()">Se connecter</button>
    <div id="loginError" class="danger"></div>
  </div>
  <div id="adminPanel" style="display:none;">
    <h2>Capsules (Gestion Admin)</h2>
    <form id="addCapsuleForm">
      <input type="text" id="capsTitle" placeholder="Titre" required>
      <textarea id="capsContent" placeholder="Contenu" required></textarea>
      <button type="submit">Ajouter la capsule</button>
    </form>
    <div class="capsule-admin-slider" style="margin-bottom:26px;">
      <button class="slider-btn" id="prevCapsuleBtn" title="Capsule pr√©c√©dente">‚Üê</button>
      <div id="adminCapsule"></div>
      <button class="slider-btn" id="nextCapsuleBtn" title="Capsule suivante">‚Üí</button>
    </div>
    <button onclick="logoutAdmin()">D√©connexion</button>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let capsules = [];
    let currentIndex = 0;

    window.loginAdmin = function() {
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("adminPanel").style.display = "";
      loadCapsules();
    };
    window.logoutAdmin = function() {
      document.getElementById("loginBox").style.display = "";
      document.getElementById("adminPanel").style.display = "none";
    };

    document.getElementById("addCapsuleForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const titre = document.getElementById("capsTitle").value.trim();
      const contenu = document.getElementById("capsContent").value.trim();
      if (!titre || !contenu) return alert("Merci de remplir tous les champs.");
      await addDoc(collection(db, "capsules"), {
        titre: titre,
        contenu: contenu,
        date: serverTimestamp(),
        lectures: 0,
        votes_up: 0,
        votes_down: 0,
        commentaires: []
      });
      document.getElementById("capsTitle").value = "";
      document.getElementById("capsContent").value = "";
      await loadCapsules();
      alert("Capsule ajout√©e !");
    });

    async function loadCapsules() {
      const querySnapshot = await getDocs(collection(db, "capsules"));
      capsules = [];
      querySnapshot.forEach((docu) => {
        capsules.push({ id: docu.id, ...docu.data() });
      });
      if (capsules.length === 0) {
        document.getElementById("adminCapsule").innerHTML = "<div class='capsule'><i>Aucune capsule enregistr√©e.</i></div>";
        currentIndex = 0;
        return;
      }
      if (currentIndex >= capsules.length) currentIndex = capsules.length-1;
      showCapsule(currentIndex);
    }

    function showCapsule(idx) {
      if (capsules.length === 0) return;
      currentIndex = idx;
      const cap = capsules[currentIndex];
      document.getElementById("adminCapsule").innerHTML = `
        <div class="capsule">
          <div class="capsule-content">
            <b>${cap.titre || ""}</b>
            <div style="margin:7px 0 13px 0;">${cap.contenu || ""}</div>
          </div>
          <div style="margin-top:16px;">
            Votes : ${cap.votes_up||0} üëç / ${cap.votes_down||0} üëé ‚Äî Lectures : ${cap.lectures||0}
          </div>
          <button style="margin-top:18px;" onclick="deleteCapsule('${cap.id}')">üóëÔ∏è Supprimer</button>
          <div style="margin-top:8px;font-size:0.97em;color:#44f">Capsule ${currentIndex+1} / ${capsules.length}</div>
        </div>
      `;
    }

    document.getElementById("prevCapsuleBtn").onclick = function() {
      if (capsules.length > 0 && currentIndex > 0) showCapsule(currentIndex-1);
    };
    document.getElementById("nextCapsuleBtn").onclick = function() {
      if (capsules.length > 0 && currentIndex < capsules.length-1) showCapsule(currentIndex+1);
    };

    window.deleteCapsule = async function(id) {
      if (!confirm("Supprimer cette capsule‚ÄØ?")) return;
      await deleteDoc(doc(db, "capsules", id));
      await loadCapsules();
    };

    window.showCapsule = showCapsule;
  </script>
</body>
</html>
